# IMD (Intensity Modulated Display) Macro - 使い方

## 改良点

### 1. ダイアログによる画像選択
- マクロ実行時に、開いている画像の中からFRET画像とCFP画像を選択できます
- Image Calculatorも自動的に実行されるため、事前にRatio画像を作成する必要がありません

### 2. Stack/単一画像の自動判別
- 画像のスライス数を自動的に判別し、Stack画像でも単一画像でもエラーなく処理できます
- 処理内容はログウィンドウに表示されます

### 3. パラメータの保存機能
- パラメータは `IMD_parameters.txt` として ImageJ ディレクトリに保存されます
- 次回実行時に前回の設定値が自動的に読み込まれます

### 4. Batch mode対応
- 画像処理中の中間画像を非表示にして、ちらつきを防止します
- 処理速度も向上します
- ダイアログでON/OFFを選択可能です

### 5. バックグラウンド減算機能
- Rolling ballアルゴリズムによるバックグラウンド減算を自動実行できます
- 半径のパラメータを調整可能です
- 元の画像は保持されます（コピーに対して処理）

### 6. テストモード
- Stack画像の場合、最初のフレームのみを処理してパラメータを素早く調整できます
- 大量のタイムポイントがある場合でも、設定を試すのに時間がかかりません
- 適切なパラメータが見つかったら、テストモードをOFFにして全フレームを処理します

## 使用方法

### 基本的な使い方

1. **画像の準備**
   - FRET画像とCFP（Donor）画像をImageJで開きます
   - バックグラウンド減算はマクロ内で実行できるため、事前処理は不要です
   - 必要に応じて、メディアンフィルタ（Process > Filters > Median...）を適用します

2. **マクロの実行**
   - Plugins > Macros > Run... から `20251106-IMD_improved.ijm` を選択
   - または、Plugins > Macros > Install... でインストールしてから実行

3. **ダイアログでの設定**
   ```
   Image Selection:
   - FRET image: FRET画像を選択
   - CFP (Donor) image: CFP画像を選択
   
   Ratio Range:
   - Ratio max: Ratioの最大値（デフォルト: 3）
   - Ratio min: Ratioの最小値（デフォルト: -1）
   
   Donor Intensity Range:
   - Donor max: CFP輝度の最大値（デフォルト: 6000）
   - Donor min: CFP輝度の最小値（デフォルト: 0）
   
   Options:
   - Test mode: Stack画像の場合、最初のフレームのみを処理（パラメータ調整用）
   - Subtract background (Rolling ball): チェックするとバックグラウンド減算を実行
   - Rolling ball radius: Rolling ballアルゴリズムの半径（デフォルト: 50）
   - Save parameters to file: チェックすると設定値が保存されます
   - Use batch mode: チェックすると画像処理中の表示を非表示にします（高速化、ちらつき防止）
   ```

4. **結果**
   - `IMD-RmaxX-RminY-DmaxZ-DminW` という名前で結果画像が生成されます
   - Physics LUTが適用され、CFP輝度で明るさが規格化されています

### パラメータファイルについて

パラメータファイル（`IMD_parameters.txt`）は ImageJ ディレクトリに保存されます。

**ファイルの場所を確認する方法:**
```
Edit > Options > Memory & Threads... 
ウィンドウ上部に表示されるパスがImageJディレクトリです
```

**ファイルの内容例:**
```
rmax=3
rmin=-1
dmax=6000
dmin=0
rolling_ball_radius=50
```

**手動でパラメータを編集する場合:**
- テキストエディタで `IMD_parameters.txt` を開いて編集できます
- 次回マクロ実行時に、編集した値がデフォルト値として使用されます

## トラブルシューティング

### エラー: "Please open at least 2 images"
- FRET画像とCFP画像の両方をImageJで開いてください

### エラー: "Please select different images"
- FRET画像とCFP画像に同じ画像を選択していないか確認してください

### エラー: "FRET and CFP images must have the same number of slices"
- FRET画像とCFP画像のスライス数（フレーム数）が一致しているか確認してください
- タイムラプス画像の場合、同じフレーム数である必要があります

### 結果画像が暗すぎる/明るすぎる
- Donor max/min の値を調整してください
- CFP画像のヒストグラムを確認して、適切な範囲を設定します

### Ratio値の範囲が適切でない
- Ratio max/min の値を調整してください
- Ratio画像のヒストグラムを確認して、適切な範囲を設定します

### バックグラウンド減算の効果が強すぎる/弱すぎる
- Rolling ball radius の値を調整してください
- 大きな値（50-100）：大きな背景の不均一性を除去
- 小さな値（10-30）：細かい背景の変動を除去
- 細胞のサイズよりも大きい半径を選択することを推奨します

### テストモードで処理が速くならない
- 単一画像（スナップショット）の場合、テストモードの効果はありません
- Stack画像のみでテストモードが有効です
- ログウィンドウで「TEST MODE: Processing first frame only」と表示されているか確認してください

## 推奨ワークフロー

1. **画像の準備**
   ```
   ※ マクロ内でバックグラウンド減算を実行できるため、事前処理は不要です
   ※ ノイズが多い場合は、Process > Filters > Median... (radius: 1-2) を適用してください
   ```

2. **パラメータの最適化（Stack画像の場合）**
   - マクロを実行し、**「Test mode」をチェック**
   - 最初のフレームのみで処理されるため、素早く結果を確認できます
   - Ratio range、Donor range、Rolling ball radius を調整
   - 適切なパラメータが見つかるまで繰り返します
   - "Save parameters to file" をチェックして設定を保存

3. **全フレームの処理**
   - マクロを再度実行し、**「Test mode」のチェックを外す**
   - 保存されたパラメータが自動的に適用されます
   - 全フレームが処理されます

4. **バッチ処理**
   - 同じ実験条件の画像には、保存されたパラメータが自動的に適用されます

## 元のマクロとの違い

| 項目 | 元のマクロ | 改良版マクロ |
|------|-----------|-------------|
| 画像選択 | マクロ内で画像名を指定 | ダイアログで選択 |
| Ratio画像作成 | 事前に手動で作成 | 自動作成 |
| 単一画像対応 | ❌ エラーが出る | ✅ 自動判別して対応 |
| パラメータ保存 | ❌ マクロを編集 | ✅ txtファイルに保存 |
| ログ出力 | なし | 処理内容を表示 |
| Batch mode | なし | ✅ ON/OFF選択可能 |
| バックグラウンド減算 | 手動で事前処理 | ✅ オプションで自動実行 |
| テストモード | なし | ✅ 最初のフレームのみ処理 |

## 注意事項

- 元の画像は保持されます（コピーを作成して処理）
- 中間生成物（Ratio画像）は処理後に自動的に閉じられます
- Stack画像の場合、各スライスに対して同じパラメータが適用されます
- テストモードは単一画像には効果がなく、Stack画像のみで有効です
- テストモードで最適なパラメータを見つけたら、必ずテストモードを解除して全フレームを処理してください

## 技術的な詳細

### Split Channelsの挙動の違い
ImageJの`Split Channels`コマンドは、画像のタイプによって異なるウィンドウ名を生成します：

- **Stack画像**: `C1-imagename`, `C2-imagename`, `C3-imagename`
- **単一画像（Snapshot）**: `imagename (red)`, `imagename (green)`, `imagename (blue)`

このマクロは両方の形式に自動的に対応しており、ログウィンドウに使用されている形式が表示されます。
